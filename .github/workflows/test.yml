name: Shiroxy CI - Tests and Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests and Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Run unit tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Display coverage summary
        run: |
          echo "=== Coverage Summary ==="
          go tool cover -func=coverage.txt | grep total
          echo ""
          echo "=== Package Coverage ==="
          go tool cover -func=coverage.txt | grep -E "cmd/shiroxy/(analytics|api|proxy|domains|webhook)" | sort -t: -k2 -rn

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.txt
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Shiroxy code
        uses: actions/checkout@v4
        with:
          path: shiroxy

      - name: Checkout test backend code
        uses: actions/checkout@v4
        with:
          repository: shikharcodess/shiroxy-dummy
          path: shiroxy-dummy

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true
          cache-dependency-path: shiroxy/go.sum

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl netcat-openbsd

      - name: Build and start test backend containers
        run: |
          cd shiroxy-dummy

          # Build the Docker image for test backends
          docker build -t shiroxy-test-backend .

          # Start 3 backend instances on different ports
          docker run -d --name backend-1 -p 8001:8000 \
            -e PORT=8000 \
            -e SERVER_NAME=backend-1 \
            shiroxy-test-backend

          docker run -d --name backend-2 -p 8002:8000 \
            -e PORT=8000 \
            -e SERVER_NAME=backend-2 \
            shiroxy-test-backend

          docker run -d --name backend-3 -p 8003:8000 \
            -e PORT=8000 \
            -e SERVER_NAME=backend-3 \
            shiroxy-test-backend

          cd ..

      - name: Wait for backend services to be ready
        run: |
          echo "Waiting for backend services to start..."

          # Wait for backend-1
          backend1_ready=false
          for i in {1..30}; do
            if curl -sf http://localhost:8001/health > /dev/null; then
              echo "✓ Backend-1 is ready"
              backend1_ready=true
              break
            fi
            echo "Waiting for backend-1... ($i/30)"
            sleep 2
          done
          if [ "$backend1_ready" = "false" ]; then
            echo "ERROR: Backend-1 failed to start after 60 seconds"
            docker logs backend-1
            exit 1
          fi

          # Wait for backend-2
          backend2_ready=false
          for i in {1..30}; do
            if curl -sf http://localhost:8002/health > /dev/null; then
              echo "✓ Backend-2 is ready"
              backend2_ready=true
              break
            fi
            echo "Waiting for backend-2... ($i/30)"
            sleep 2
          done
          if [ "$backend2_ready" = "false" ]; then
            echo "ERROR: Backend-2 failed to start after 60 seconds"
            docker logs backend-2
            exit 1
          fi

          # Wait for backend-3
          backend3_ready=false
          for i in {1..30}; do
            if curl -sf http://localhost:8003/health > /dev/null; then
              echo "✓ Backend-3 is ready"
              backend3_ready=true
              break
            fi
            echo "Waiting for backend-3... ($i/30)"
            sleep 2
          done
          if [ "$backend3_ready" = "false" ]; then
            echo "ERROR: Backend-3 failed to start after 60 seconds"
            docker logs backend-3
            exit 1
          fi

          echo "All backends are ready!"

      - name: Install Shiroxy dependencies
        run: |
          cd shiroxy
          go mod download

      - name: Create CI config file
        run: |
          cd shiroxy

          # Create a CI-specific config with correct paths
          mkdir -p /tmp/shiroxy-ci

          cat > defaults/shiroxy.conf.ci.yaml << 'EOF'
          version: "1.0.0"

          runtime:
            mode: "stage"
            instancename: "shiroxy-ci"

          default:
            environment: "ci"
            mode: "dev"
            logpath: "/tmp/shiroxy-ci"
            datapersistancepath: "/tmp/shiroxy-ci"
            enablednschallengesolver: ""
            
            timeout:
              connect: "10s"
              client: "10s"
              server: "10s"
            
            storage:
              location: "memory"
            
            analytics:
              collectioninterval: 10
              routename: "/analytics"
            
            errorresponses:
              errorpagebuttonname: "Shiroxy"
              errorpagebuttonurl: "https://github.com/ShikharY10/shiroxy"
            
            user:
              email: "ci@test.com"
              secret: "test-secret"
            
            adminapi:
              port: "2210"
              basepath: "admin"

          frontend:
            mode: "http"
            httptohttps: false
            bind:
              - port: "80"
                host: ""
                target: "single"
                secure: false
            
            options:
              - "http-server-close"
              - "forwardfor"

          backend:
            name: "shiroxy-test"
            balance: "round-robin"
            tagrule: "none"
            noserveraction: "strict"
            
            servers:
              - id: "backend-1"
                host: "localhost"
                port: "8001"
                healthurl: "http://localhost:8001/health"
              
              - id: "backend-2"
                host: "localhost"
                port: "8002"
                healthurl: "http://localhost:8002/health"
              
              - id: "backend-3"
                host: "localhost"
                port: "8003"
                healthurl: "http://localhost:8003/health"
            
            healthcheckmode: "url"
            healthchecktriggerduration: 10

          logging:
            enable: true
            mode: "native"
            schema:
              - "[date-time] "
            include:
              - "*"

          webhook:
            enable: false
          EOF

      - name: Build Shiroxy binary
        run: |
          cd shiroxy
          go build -o shiroxy-bin cmd/shiroxy/main.go

      - name: Start Shiroxy proxy
        run: |
          cd shiroxy

          # Start Shiroxy in background with CI config
          sudo ./shiroxy-bin -c defaults/shiroxy.conf.ci.yaml > shiroxy.log 2>&1 &
          SHIROXY_PID=$!
          echo $SHIROXY_PID > shiroxy.pid

          # Wait for Shiroxy to be ready with better checking
          echo "Waiting for Shiroxy to start..."
          shiroxy_ready=false
          for i in {1..30}; do
            if sudo lsof -i :80 > /dev/null 2>&1; then
              echo "✓ Shiroxy is listening on port 80"
              shiroxy_ready=true
              break
            fi
            
            # Check if process is still running
            if ! ps -p $SHIROXY_PID > /dev/null 2>&1; then
              echo "ERROR: Shiroxy process died"
              echo "=== Shiroxy logs ==="
              cat shiroxy.log
              exit 1
            fi
            
            echo "Waiting for port 80... ($i/30)"
            sleep 2
          done

          if [ "$shiroxy_ready" = "false" ]; then
            echo "ERROR: Shiroxy failed to start after 60 seconds"
            echo "=== Shiroxy logs ==="
            cat shiroxy.log
            exit 1
          fi

          echo "✓ Shiroxy is running (PID: $SHIROXY_PID)"

      - name: Verify Shiroxy connectivity
        run: |
          cd shiroxy

          # Test if port 80 is listening
          if ! sudo lsof -i :80 > /dev/null 2>&1; then
            echo "ERROR: Port 80 is not listening"
            echo "=== Shiroxy logs ==="
            cat shiroxy.log
            exit 1
          fi

          echo "✓ Shiroxy is listening on port 80"

          # Try a basic HTTP request
          if curl -f http://localhost:80 > /dev/null 2>&1 || [ $? -eq 22 ]; then
            echo "✓ Shiroxy is responding to HTTP requests"
          else
            echo "WARNING: Shiroxy may not be responding properly"
            cat shiroxy.log
          fi

      - name: Run integration tests
        run: |
          cd shiroxy

          # Make test script executable
          chmod +x test/test_backend_fixed.sh

          # Run tests and capture exit code
          cd test
          set +e  # Don't exit on error immediately
          BASE_URL="http://localhost:80" ./test_backend_fixed.sh | tee test_results.log
          test_exit_code=$?
          set -e  # Re-enable exit on error

          # Check test results
          if [ $test_exit_code -ne 0 ]; then
            echo "Tests failed with exit code: $test_exit_code"
            exit 1
          fi

          echo "✓ All integration tests passed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            shiroxy/test/test_results.log
            shiroxy/shiroxy.log

      - name: Display Shiroxy logs on failure
        if: failure()
        run: |
          echo "=== Shiroxy logs ==="
          cat shiroxy/shiroxy.log || echo "No logs found"

          echo ""
          echo "=== Backend-1 logs ==="
          docker logs backend-1 || echo "No logs found"

          echo ""
          echo "=== Backend-2 logs ==="
          docker logs backend-2 || echo "No logs found"

          echo ""
          echo "=== Backend-3 logs ==="
          docker logs backend-3 || echo "No logs found"

      - name: Cleanup
        if: always()
        run: |
          # Kill Shiroxy
          if [ -f shiroxy/shiroxy.pid ]; then
            sudo kill $(cat shiroxy/shiroxy.pid) || true
            rm shiroxy/shiroxy.pid
          fi

          # Stop and remove backend containers
          docker stop backend-1 backend-2 backend-3 || true
          docker rm backend-1 backend-2 backend-3 || true

  feature-tests:
    name: Feature Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        feature:
          - http2-connection-pooling
          - gzip-compression
          - load-balancing
          - health-checks
          - buffer-pool

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install test dependencies
        run: |
          go mod download
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Run ${{ matrix.feature }} tests
        run: |
          case "${{ matrix.feature }}" in
            http2-connection-pooling)
              echo "Testing HTTP/2 connection pooling..."
              go test -v -run TestHTTP2 ./cmd/shiroxy/proxy/
              ;;
            gzip-compression)
              echo "Testing gzip compression..."
              go test -v -run "TestGzip|TestContent|TestCopy|TestRemove|TestUpgrade|TestClean" ./cmd/shiroxy/proxy/
              ;;
            load-balancing)
              echo "Testing load balancing..."
              go test -v -run TestBalancer ./cmd/shiroxy/proxy/
              go test -v -run "TestGetNextServer|TestGetLeastConnection|TestGetStickySession" ./cmd/shiroxy/proxy/
              ;;
            health-checks)
              echo "Testing health checks..."
              go test -v -run TestHealthCheck ./cmd/shiroxy/proxy/
              ;;
            buffer-pool)
              echo "Testing buffer pool..."
              go test -v -run TestBufferPool ./cmd/shiroxy/proxy/
              go test -v -run TestSyncBufferPool ./cmd/shiroxy/proxy/
              ;;
          esac

  analytics-tests:
    name: Analytics Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install dependencies
        run: go mod download

      - name: Run analytics tests
        run: |
          echo "Testing analytics module..."
          go test -v -race -coverprofile=analytics_coverage.txt ./cmd/shiroxy/analytics/

      - name: Display analytics coverage
        run: |
          echo "=== Analytics Coverage ==="
          go tool cover -func=analytics_coverage.txt | grep total

      - name: Upload analytics coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./analytics_coverage.txt
          flags: analytics
          name: analytics-coverage
          fail_ci_if_error: false

  api-tests:
    name: API Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install dependencies
        run: go mod download

      - name: Run API tests
        run: |
          echo "Testing API layer..."
          go test -v -race -coverprofile=api_coverage.txt ./cmd/shiroxy/api/

      - name: Display API coverage
        run: |
          echo "=== API Coverage ==="
          go tool cover -func=api_coverage.txt | grep total

      - name: Upload API coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./api_coverage.txt
          flags: api
          name: api-coverage
          fail_ci_if_error: false

  compression-tests:
    name: Compression Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install dependencies
        run: go mod download

      - name: Run compression tests
        run: |
          echo "Testing gzip compression and content-type preservation..."
          go test -v -race -coverprofile=compression_coverage.txt -run "TestGzip|TestContent|TestCopy|TestRemove|TestUpgrade|TestClean" ./cmd/shiroxy/proxy/

      - name: Display compression coverage
        run: |
          echo "=== Compression Tests Coverage ==="
          go tool cover -func=compression_coverage.txt | grep total

      - name: Upload compression coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./compression_coverage.txt
          flags: compression
          name: compression-coverage
          fail_ci_if_error: false

  performance-benchmarks-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install dependencies
        run: go mod download

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -benchtime=10s ./cmd/shiroxy/proxy/ > benchmark.txt
          cat benchmark.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark.txt

  security-tests:
    name: Security and Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run go vet
        run: go vet ./...

      - name: Run staticcheck
        uses: dominikh/staticcheck-action@v1
        with:
          version: "latest"
          install-go: false

      - name: Run gosec security scanner
        id: gosec
        run: |
          # Install gosec
          go install github.com/securego/gosec/v2/cmd/gosec@latest

          # Run gosec and generate SARIF report
          $(go env GOPATH)/bin/gosec -no-fail -fmt sarif -out results.sarif ./... || true

          # Check if SARIF file was created
          if [ -f results.sarif ]; then
            echo "sarif_generated=true" >> $GITHUB_OUTPUT
            echo "✓ SARIF report generated"
          else
            echo "sarif_generated=false" >> $GITHUB_OUTPUT
            echo "⚠ SARIF report not generated"
          fi
        continue-on-error: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        if: steps.gosec.outputs.sarif_generated == 'true'
        continue-on-error: true

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: shiroxy:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm --name shiroxy-test -d -p 8080:80 shiroxy:test
          sleep 5

          # Test if container is running
          if ! docker ps | grep shiroxy-test; then
            echo "Container failed to start"
            docker logs shiroxy-test
            exit 1
          fi

          docker stop shiroxy-test

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests,
        integration-tests,
        feature-tests,
        analytics-tests,
        api-tests,
        compression-tests,
        performance-benchmarks-tests,
        security-tests,
        docker-build,
      ]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "======================================"
          echo "  SHIROXY TEST SUITE SUMMARY"
          echo "======================================"
          echo ""
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Feature Tests: ${{ needs.feature-tests.result }}"
          echo "Analytics Tests: ${{ needs.analytics-tests.result }}"
          echo "API Tests: ${{ needs.api-tests.result }}"
          echo "Compression Tests: ${{ needs.compression-tests.result }}"
          echo "Performance Benchmarks: ${{ needs.performance-benchmarks-tests.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          echo ""
          echo "======================================"

          if [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
             [[ "${{ needs.feature-tests.result }}" != "success" ]] || \
             [[ "${{ needs.analytics-tests.result }}" != "success" ]] || \
             [[ "${{ needs.api-tests.result }}" != "success" ]] || \
             [[ "${{ needs.compression-tests.result }}" != "success" ]]; then
            echo "❌ Some critical tests failed!"
            exit 1
          fi

          echo "✅ All critical tests passed!"
          echo ""
          echo "Coverage reports uploaded to Codecov"
          echo "View at: https://codecov.io/gh/shikharcodess/shiroxy"
